<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4ade80">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ApartaLo Admin</title>
    <link rel="manifest" href="/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #4ade80; --primary-dark: #22c55e;
            --bg-dark: #0f0f1a; --bg-card: #1a1a2e; --bg-input: #252540;
            --text: #ffffff; --text-muted: #9ca3af;
            --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6; --success: #22c55e;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; padding-bottom: 80px; }
        .header { background: var(--bg-card); padding: 16px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #2a2a4a; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .logo span { color: var(--text); }
        .business-select { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid #3a3a5a; border-radius: 8px; color: var(--text); font-size: 1rem; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-card); display: flex; justify-content: space-around; padding: 8px 0; border-top: 1px solid #2a2a4a; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; padding: 8px 16px; color: var(--text-muted); text-decoration: none; font-size: 0.75rem; transition: color 0.2s; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; }
        .content { padding: 16px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--bg-card); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .card-title { font-weight: 600; font-size: 1rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px; }
        .stat-card { background: var(--bg-card); border-radius: 12px; padding: 16px; text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.875rem; color: var(--text-muted); }
        .product-item { display: flex; align-items: center; padding: 12px; background: var(--bg-input); border-radius: 8px; margin-bottom: 8px; }
        .product-info { flex: 1; }
        .product-name { font-weight: 600; margin-bottom: 4px; }
        .product-meta { font-size: 0.875rem; color: var(--text-muted); }
        .product-price { font-weight: 700; color: var(--primary); margin-right: 12px; }
        .product-stock { background: var(--bg-card); padding: 4px 8px; border-radius: 4px; font-size: 0.875rem; }
        .stock-low { color: var(--danger); }
        .order-item { background: var(--bg-input); border-radius: 8px; padding: 12px; margin-bottom: 8px; }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .order-id { font-weight: 600; font-size: 1rem; }
        .order-status { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .status-PENDIENTE_PAGO { background: #fef3c7; color: #92400e; }
        .status-PENDIENTE_VALIDACION { background: #dbeafe; color: #1e40af; }
        .status-CONFIRMADO { background: #d1fae5; color: #065f46; }
        .status-EN_PREPARACION { background: #e0e7ff; color: #3730a3; }
        .status-ENVIADO { background: #cffafe; color: #0e7490; }
        .status-ENTREGADO { background: #dcfce7; color: #166534; }
        .status-CANCELADO { background: #fee2e2; color: #991b1b; }
        .order-details { font-size: 0.875rem; color: var(--text-muted); }
        .order-total { font-weight: 700; color: var(--primary); font-size: 1.125rem; margin-top: 8px; }
        .client-item { display: flex; align-items: center; padding: 12px; background: var(--bg-input); border-radius: 8px; margin-bottom: 8px; }
        .client-avatar { width: 48px; height: 48px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.25rem; margin-right: 12px; }
        .client-info { flex: 1; }
        .client-name { font-weight: 600; }
        .client-phone { font-size: 0.875rem; color: var(--text-muted); }
        .btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 1rem; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--bg-input); color: var(--text); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-block { width: 100%; }
        .fab { position: fixed; bottom: 90px; right: 16px; width: 56px; height: 56px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(74, 222, 128, 0.3); cursor: pointer; z-index: 99; }
        .fab svg { width: 24px; height: 24px; color: #000; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: flex-end; z-index: 200; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); width: 100%; max-height: 90vh; border-radius: 20px 20px 0 0; padding: 24px; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.25rem; font-weight: 700; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-muted); }
        .form-input { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid #3a3a5a; border-radius: 8px; color: var(--text); font-size: 1rem; }
        .form-input:focus { outline: none; border-color: var(--primary); }
        .form-input:disabled { opacity: 0.6; }
        .status-select { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 12px; }
        .status-option { padding: 12px; border-radius: 8px; text-align: center; font-size: 0.75rem; font-weight: 600; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .status-option.selected { border-color: var(--primary); }
        .loading { text-align: center; padding: 40px; color: var(--text-muted); }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--bg-input); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }
        .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--bg-card); padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 300; display: none; }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.show { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        .search-box { position: relative; margin-bottom: 16px; }
        .search-box input { width: 100%; padding: 12px 12px 12px 44px; background: var(--bg-input); border: 1px solid #3a3a5a; border-radius: 8px; color: var(--text); font-size: 1rem; }
        .search-box svg { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); width: 20px; height: 20px; }
        .filters { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px; }
        .filter-chip { padding: 8px 16px; background: var(--bg-input); border-radius: 20px; font-size: 0.875rem; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
        .filter-chip.active { background: var(--primary); color: #000; }
        .refresh-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 8px; }
        .refresh-btn.loading svg { animation: spin 1s linear infinite; }
        .code-badge { background: var(--primary); color: #000; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 1rem; display: inline-block; margin-bottom: 16px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-top">
            <div class="logo">Aparta<span>Lo</span></div>
            <button class="refresh-btn" onclick="refreshData()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
            </button>
        </div>
        <select class="business-select" id="businessSelect" onchange="changeBusiness()">
            <option value="">Cargando negocios...</option>
        </select>
    </header>
    
    <main class="content">
        <div id="tab-dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="stat-products">-</div><div class="stat-label">Productos</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-orders">-</div><div class="stat-label">Pedidos Hoy</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-pending">-</div><div class="stat-label">Pendientes</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-clients">-</div><div class="stat-label">Clientes</div></div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">üìã √öltimos Pedidos</span></div>
                <div id="recent-orders"><div class="loading"><div class="spinner"></div>Cargando...</div></div>
            </div>
        </div>
        
        <div id="tab-products" class="tab-content">
            <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                <input type="text" placeholder="Buscar producto..." id="searchProducts" oninput="filterProducts()">
            </div>
            <div id="products-list"><div class="loading"><div class="spinner"></div>Cargando productos...</div></div>
        </div>
        
        <div id="tab-orders" class="tab-content">
            <div class="filters" id="order-filters">
                <div class="filter-chip active" data-filter="all">Todos</div>
                <div class="filter-chip" data-filter="PENDIENTE_PAGO">üí∞ Pago</div>
                <div class="filter-chip" data-filter="PENDIENTE_VALIDACION">üîç Validar</div>
                <div class="filter-chip" data-filter="CONFIRMADO">‚úÖ Confirmado</div>
                <div class="filter-chip" data-filter="EN_PREPARACION">üì¶ Preparando</div>
                <div class="filter-chip" data-filter="ENVIADO">üöö Enviado</div>
            </div>
            <div id="orders-list"><div class="loading"><div class="spinner"></div>Cargando pedidos...</div></div>
        </div>
        
        <div id="tab-clients" class="tab-content">
            <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                <input type="text" placeholder="Buscar cliente..." id="searchClients" oninput="filterClients()">
            </div>
            <div id="clients-list"><div class="loading"><div class="spinner"></div>Cargando clientes...</div></div>
        </div>
    </main>
    
    <div class="fab" id="fab" onclick="openAddProduct()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
    </div>
    
    <nav class="bottom-nav">
        <div class="nav-item active" data-tab="dashboard">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>Inicio
        </div>
        <div class="nav-item" data-tab="products">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>Productos
        </div>
        <div class="nav-item" data-tab="orders">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Pedidos
        </div>
        <div class="nav-item" data-tab="clients">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>Clientes
        </div>
    </nav>
    
    <!-- Modal: Product Form -->
    <div class="modal-overlay" id="modal-product">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="product-modal-title">Nuevo Producto</span>
                <button class="modal-close" onclick="closeModal('modal-product')">&times;</button>
            </div>
            <div id="product-code-display"></div>
            <form id="product-form" onsubmit="saveProduct(event)">
                <input type="hidden" id="product-edit-code">
                <div class="form-group">
                    <label class="form-label">Nombre *</label>
                    <input type="text" class="form-input" id="product-nombre" required placeholder="Nombre del producto">
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <input type="text" class="form-input" id="product-descripcion" placeholder="Descripci√≥n breve">
                </div>
                <div class="form-group">
                    <label class="form-label">Precio *</label>
                    <input type="number" class="form-input" id="product-precio" required step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="form-label">Stock *</label>
                    <input type="number" class="form-input" id="product-stock" required min="0" placeholder="0">
                </div>
                <div class="form-group">
                    <label class="form-label">URL Imagen</label>
                    <input type="url" class="form-input" id="product-imagen" placeholder="https://...">
                </div>
                <button type="submit" class="btn btn-primary btn-block">Guardar Producto</button>
            </form>
        </div>
    </div>
    
    <!-- Modal: Order Detail -->
    <div class="modal-overlay" id="modal-order">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Pedido <span id="order-detail-id"></span></span>
                <button class="modal-close" onclick="closeModal('modal-order')">&times;</button>
            </div>
            <div id="order-detail-content"></div>
            <div class="form-group">
                <label class="form-label">Cambiar Estado:</label>
                <div class="status-select" id="status-options"></div>
            </div>
            <button class="btn btn-primary btn-block" onclick="updateOrderStatus()">Actualizar Estado</button>
            <button class="btn btn-danger btn-block" style="margin-top:8px" onclick="cancelOrder()">Cancelar Pedido</button>
        </div>
    </div>
    
    <!-- Modal: Client Detail -->
    <div class="modal-overlay" id="modal-client">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Cliente</span>
                <button class="modal-close" onclick="closeModal('modal-client')">&times;</button>
            </div>
            <div id="client-detail-content"></div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        let currentBusiness = null, businesses = [], products = [], orders = [], clients = [], currentOrder = null, selectedStatus = null;
        const API_BASE = '/api';
        const ESTADOS = [
            { id: 'PENDIENTE_PAGO', label: 'üí∞ Pago Pendiente' },
            { id: 'PENDIENTE_VALIDACION', label: 'üîç Validando' },
            { id: 'CONFIRMADO', label: '‚úÖ Confirmado' },
            { id: 'EN_PREPARACION', label: 'üì¶ Preparando' },
            { id: 'ENVIADO', label: 'üöö Enviado' },
            { id: 'ENTREGADO', label: 'üéâ Entregado' }
        ];
        
        async function init() { await loadBusinesses(); setupNavigation(); setupFilters(); registerSW(); }
        function registerSW() { if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(e => console.log(e)); }
        
        async function api(endpoint, options = {}) {
            try {
                const res = await fetch(API_BASE + endpoint, { ...options, headers: { 'Content-Type': 'application/json', ...options.headers } });
                return await res.json();
            } catch (err) { showToast('Error de conexi√≥n', 'error'); return { success: false, error: err.message }; }
        }
        
        async function loadBusinesses() {
            const data = await api('/negocios');
            if (data.success && data.data.length > 0) {
                businesses = data.data;
                document.getElementById('businessSelect').innerHTML = businesses.map(b => `<option value="${b.id}">${b.nombre} (${b.prefijo})</option>`).join('');
                currentBusiness = businesses[0].id;
                loadAllData();
            }
        }
        
        function changeBusiness() { currentBusiness = document.getElementById('businessSelect').value; loadAllData(); }
        async function loadAllData() { if (!currentBusiness) return; await Promise.all([loadProducts(), loadOrders(), loadClients(), loadStats()]); }
        async function refreshData() { document.querySelector('.refresh-btn').classList.add('loading'); await loadAllData(); document.querySelector('.refresh-btn').classList.remove('loading'); showToast('Datos actualizados', 'success'); }
        
        async function loadStats() {
            const stats = await api(`/${currentBusiness}/pedidos/stats`);
            if (stats.success) {
                document.getElementById('stat-orders').textContent = stats.data.hoy || 0;
                document.getElementById('stat-pending').textContent = (stats.data.porEstado?.PENDIENTE_PAGO || 0) + (stats.data.porEstado?.PENDIENTE_VALIDACION || 0);
            }
            document.getElementById('stat-products').textContent = products.length;
            document.getElementById('stat-clients').textContent = clients.length;
        }
        
        async function loadProducts() { const data = await api(`/${currentBusiness}/productos`); if (data.success) { products = data.data; renderProducts(); } }
        async function loadOrders() { const data = await api(`/${currentBusiness}/pedidos`); if (data.success) { orders = data.data; renderOrders(); renderRecentOrders(); } }
        async function loadClients() { const data = await api(`/${currentBusiness}/clientes`); if (data.success) { clients = data.data; renderClients(); } }
        
        function renderProducts(filtered = null) {
            const list = document.getElementById('products-list');
            const data = filtered || products;
            if (data.length === 0) { list.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/></svg><p>No hay productos</p></div>'; return; }
            list.innerHTML = data.map(p => `<div class="product-item" onclick="editProduct('${p.codigo}')"><div class="product-info"><div class="product-name">${p.codigo} - ${p.nombre}</div><div class="product-meta">${p.descripcion || 'Sin descripci√≥n'}</div></div><span class="product-price">S/${p.precio.toFixed(2)}</span><span class="product-stock ${p.disponible < 3 ? 'stock-low' : ''}">${p.disponible} disp.</span></div>`).join('');
        }
        
        function renderOrders(filter = 'all') {
            const list = document.getElementById('orders-list');
            let data = filter !== 'all' ? orders.filter(o => o.estado === filter) : orders;
            if (data.length === 0) { list.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/></svg><p>No hay pedidos</p></div>'; return; }
            list.innerHTML = data.map(o => `<div class="order-item" onclick="openOrder('${o.id}')"><div class="order-header"><span class="order-id">${o.id}</span><span class="order-status status-${o.estado}">${o.estado.replace(/_/g, ' ')}</span></div><div class="order-details"><div>üë§ ${o.cliente || 'Sin nombre'}</div><div>üì± ${o.whatsapp}</div><div>üìÖ ${o.fecha} ${o.hora}</div></div><div class="order-total">S/${o.total.toFixed(2)}</div></div>`).join('');
        }
        
        function renderRecentOrders() {
            const container = document.getElementById('recent-orders');
            const recent = orders.slice(0, 5);
            if (recent.length === 0) { container.innerHTML = '<p style="color:var(--text-muted)">No hay pedidos recientes</p>'; return; }
            container.innerHTML = recent.map(o => `<div class="order-item" onclick="openOrder('${o.id}')" style="margin-bottom:8px"><div class="order-header"><span class="order-id">${o.id}</span><span class="order-status status-${o.estado}">${o.estado.replace(/_/g, ' ')}</span></div><div class="order-details">üë§ ${o.cliente || o.whatsapp} ‚Ä¢ S/${o.total.toFixed(2)}</div></div>`).join('');
        }
        
        function renderClients(filtered = null) {
            const list = document.getElementById('clients-list');
            const data = filtered || clients;
            if (data.length === 0) { list.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><p>No hay clientes</p></div>'; return; }
            list.innerHTML = data.map(c => `<div class="client-item" onclick="openClient('${c.whatsapp}')"><div class="client-avatar">${(c.nombre || 'U')[0].toUpperCase()}</div><div class="client-info"><div class="client-name">${c.nombre || 'Sin nombre'}</div><div class="client-phone">üì± ${c.whatsapp}</div></div></div>`).join('');
        }
        
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const tab = item.dataset.tab;
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    item.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                    document.getElementById('tab-' + tab).classList.add('active');
                    document.getElementById('fab').style.display = tab === 'products' ? 'flex' : 'none';
                });
            });
        }
        
        function setupFilters() {
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    renderOrders(chip.dataset.filter);
                });
            });
        }
        
        function openAddProduct() {
            document.getElementById('product-modal-title').textContent = 'Nuevo Producto';
            document.getElementById('product-form').reset();
            document.getElementById('product-edit-code').value = '';
            document.getElementById('product-code-display').innerHTML = '<p style="color:var(--text-muted);margin-bottom:16px">üì¶ El c√≥digo se generar√° autom√°ticamente</p>';
            openModal('modal-product');
        }
        
        function editProduct(codigo) {
            const product = products.find(p => p.codigo === codigo);
            if (!product) return;
            document.getElementById('product-modal-title').textContent = 'Editar Producto';
            document.getElementById('product-edit-code').value = codigo;
            document.getElementById('product-code-display').innerHTML = `<div class="code-badge">üì¶ ${codigo}</div>`;
            document.getElementById('product-nombre').value = product.nombre;
            document.getElementById('product-descripcion').value = product.descripcion || '';
            document.getElementById('product-precio').value = product.precio;
            document.getElementById('product-stock').value = product.stock;
            document.getElementById('product-imagen').value = product.imagenUrl || '';
            openModal('modal-product');
        }
        
        async function saveProduct(event) {
            event.preventDefault();
            const editCode = document.getElementById('product-edit-code').value;
            const data = {
                nombre: document.getElementById('product-nombre').value,
                descripcion: document.getElementById('product-descripcion').value,
                precio: parseFloat(document.getElementById('product-precio').value),
                stock: parseInt(document.getElementById('product-stock').value),
                imagenUrl: document.getElementById('product-imagen').value
            };
            let result;
            if (editCode) {
                result = await api(`/${currentBusiness}/productos/${editCode}`, { method: 'PUT', body: JSON.stringify(data) });
            } else {
                result = await api(`/${currentBusiness}/productos`, { method: 'POST', body: JSON.stringify(data) });
            }
            if (result.success) {
                showToast(editCode ? 'Producto actualizado' : `Producto creado: ${result.codigo}`, 'success');
                closeModal('modal-product');
                await loadProducts();
                await loadStats();
            } else {
                showToast(result.error || 'Error al guardar', 'error');
            }
        }
        
        function filterProducts() {
            const search = document.getElementById('searchProducts').value.toLowerCase();
            if (!search) { renderProducts(); return; }
            renderProducts(products.filter(p => p.codigo.toLowerCase().includes(search) || p.nombre.toLowerCase().includes(search)));
        }
        
        function openOrder(id) {
            currentOrder = orders.find(o => o.id === id);
            if (!currentOrder) return;
            document.getElementById('order-detail-id').textContent = currentOrder.id;
            const productos = currentOrder.productos ? currentOrder.productos.split('|').map(p => { const [codigo, nombre, cantidad, precio] = p.split(':'); return `<div>${cantidad}x ${nombre} (${codigo}) - S/${parseFloat(precio).toFixed(2)}</div>`; }).join('') : 'Sin productos';
            document.getElementById('order-detail-content').innerHTML = `<div class="card" style="background:var(--bg-input)"><p><strong>üë§ Cliente:</strong> ${currentOrder.cliente || 'Sin nombre'}</p><p><strong>üì± WhatsApp:</strong> ${currentOrder.whatsapp}</p><p><strong>üìç Direcci√≥n:</strong> ${currentOrder.direccion || 'No especificada'}</p><p><strong>üìÖ Fecha:</strong> ${currentOrder.fecha} ${currentOrder.hora}</p><hr style="border-color:#3a3a5a;margin:12px 0"><p><strong>üì¶ Productos:</strong></p>${productos}<hr style="border-color:#3a3a5a;margin:12px 0"><p style="font-size:1.25rem"><strong>Total: S/${currentOrder.total.toFixed(2)}</strong></p></div>`;
            selectedStatus = currentOrder.estado;
            document.getElementById('status-options').innerHTML = ESTADOS.map(e => `<div class="status-option status-${e.id} ${e.id === selectedStatus ? 'selected' : ''}" onclick="selectStatus('${e.id}')">${e.label}</div>`).join('');
            openModal('modal-order');
        }
        
        function selectStatus(status) {
            selectedStatus = status;
            document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`.status-option.status-${status}`).classList.add('selected');
        }
        
        async function updateOrderStatus() {
            if (!currentOrder || !selectedStatus) return;
            const result = await api(`/${currentBusiness}/pedidos/${currentOrder.id}/estado`, { method: 'PUT', body: JSON.stringify({ estado: selectedStatus }) });
            if (result.success) { showToast('Estado actualizado', 'success'); closeModal('modal-order'); await loadOrders(); await loadStats(); }
            else { showToast(result.error || 'Error al actualizar', 'error'); }
        }
        
        async function cancelOrder() {
            if (!currentOrder || !confirm('¬øCancelar este pedido? Se liberar√° el stock reservado.')) return;
            const result = await api(`/${currentBusiness}/pedidos/${currentOrder.id}/cancelar`, { method: 'POST', body: JSON.stringify({ motivo: 'Cancelado desde admin' }) });
            if (result.success) { showToast('Pedido cancelado', 'success'); closeModal('modal-order'); await loadOrders(); await loadProducts(); await loadStats(); }
            else { showToast(result.error || 'Error al cancelar', 'error'); }
        }
        
        async function openClient(whatsapp) {
            const result = await api(`/${currentBusiness}/clientes/${whatsapp}`);
            if (!result.success) { showToast('Error al cargar cliente', 'error'); return; }
            const client = result.data;
            const pedidosHtml = client.pedidos && client.pedidos.length > 0 ? client.pedidos.map(p => `<div class="order-item" style="margin-bottom:8px"><div class="order-header"><span class="order-id">${p.id}</span><span class="order-status status-${p.estado}">${p.estado.replace(/_/g,' ')}</span></div><div class="order-details">${p.fecha} ‚Ä¢ S/${p.total.toFixed(2)}</div></div>`).join('') : '<p style="color:var(--text-muted)">Sin pedidos</p>';
            document.getElementById('client-detail-content').innerHTML = `<div class="card" style="background:var(--bg-input)"><p><strong>üë§ Nombre:</strong> ${client.nombre || 'Sin nombre'}</p><p><strong>üì± WhatsApp:</strong> ${client.whatsapp}</p><p><strong>üìû Tel√©fono:</strong> ${client.telefono || 'No especificado'}</p><p><strong>üìç Direcci√≥n:</strong> ${client.direccion || 'No especificada'}</p><p><strong>üìÖ Cliente desde:</strong> ${client.fechaRegistro}</p><p><strong>üõí √öltima compra:</strong> ${client.ultimaCompra}</p></div><h3 style="margin:16px 0 12px">Historial de Pedidos</h3>${pedidosHtml}`;
            openModal('modal-client');
        }
        
        function filterClients() {
            const search = document.getElementById('searchClients').value.toLowerCase();
            if (!search) { renderClients(); return; }
            renderClients(clients.filter(c => (c.nombre || '').toLowerCase().includes(search) || c.whatsapp.includes(search)));
        }
        
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showToast(message, type = 'success') { const toast = document.getElementById('toast'); toast.textContent = message; toast.className = `toast ${type} show`; setTimeout(() => toast.classList.remove('show'), 3000); }
        document.querySelectorAll('.modal-overlay').forEach(overlay => { overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('active'); }); });
        init();
    </script>
</body>
</html>
